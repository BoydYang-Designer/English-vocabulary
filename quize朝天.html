<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>測驗頁面</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>單字測驗</h1>
    <button class="back-button" onclick="goBack()">Back</button>

    <!-- 測驗分類選擇區（使用下拉選單） -->
    <div id="categorySelection">
        <h3>選擇測驗分類</h3>
        <select id="categoryDropdown" onchange="selectCategory()">
            <option value="">請選擇分類</option>
            <option value="all">全部</option>
        </select>
        <select id="levelDropdown" onchange="selectCategory()">
            <option value="">請選擇等級</option>
            <option value="all">全部</option>
        </select>
    </div>

    <!-- 測驗開始按鈕 -->
    <button class="button" id="startQuizBtn" onclick="startQuiz()">開始測驗</button>

    <!-- 測驗區域 -->
    <div id="quizContainer" style="display: none;">
        <h3 id="question"></h3>
        <button class="button" id="playAudioBtn" onclick="playAudio()" style="display: none;">🔊 播放發音</button>
        <input type="text" id="answerInput" placeholder="輸入答案...">
        <button class="button" onclick="submitAnswer()">提交答案</button>
        <p id="feedback"></p>
    </div>

    <!-- 測驗結果區域 -->
    <div id="resultContainer" style="display: none;">
        <h3>測驗結果</h3>
        <p>總題數: <span id="totalQuestions"></span></p>
        <p>答對: <span id="correctAnswers"></span></p>
        <p>答錯: <span id="wrongAnswers"></span></p>
        <button class="button" onclick="saveResults()">儲存結果</button>
    </div>

    <script>
        let wordsData = [];
        let quizWords = [];
        let currentWord = null;

        document.addEventListener("DOMContentLoaded", function () {
            fetch("https://boydyang-designer.github.io/English-vocabulary/Z_total_words.json")
                .then(res => res.json())
                .then(data => {
                    wordsData = data["New Words"] || [];
                    populateCategoryDropdown();
                    populateLevelDropdown();
                })
                .catch(err => console.error("❌ 讀取 JSON 失敗:", err));
        });

        function populateCategoryDropdown() {
            let categories = [...new Set(wordsData.map(w => w["分類"] || "未分類"))];
            let categoryDropdown = document.getElementById("categoryDropdown");
            categories.forEach(category => {
                let option = document.createElement("option");
                option.value = category;
                option.textContent = category;
                categoryDropdown.appendChild(option);
            });
        }

        function populateLevelDropdown() {
            let levels = [...new Set(wordsData.map(w => w["等級"] || "未分類"))];
            let levelDropdown = document.getElementById("levelDropdown");
            levels.forEach(level => {
                let option = document.createElement("option");
                option.value = level;
                option.textContent = level;
                levelDropdown.appendChild(option);
            });
        }

        function selectCategory() {
            let category = document.getElementById("categoryDropdown").value;
            let level = document.getElementById("levelDropdown").value;
            if (category === "all" && level === "all") {
                quizWords = wordsData;
            } else if (category === "all") {
                quizWords = wordsData.filter(w => w["等級"] === level);
            } else if (level === "all") {
                quizWords = wordsData.filter(w => w["分類"] === category);
            } else {
                quizWords = wordsData.filter(w => w["分類"] === category && w["等級"] === level);
            }
        }

        function startQuiz() {
            if (quizWords.length === 0) {
                alert("請先選擇測驗分類或等級");
                return;
            }
            document.getElementById("categorySelection").style.display = "none";
            document.getElementById("quizContainer").style.display = "block";
            nextQuestion();
        }

        function nextQuestion() {
            if (quizWords.length === 0) {
                showResults();
                return;
            }
            currentWord = quizWords.pop();
            document.getElementById("question").textContent = `單字提示: ${currentWord.Words[0]} _ _ _ ${currentWord.Words.slice(-1)}`;
            document.getElementById("answerInput").value = "";
            document.getElementById("feedback").textContent = "";
            
            let playAudioBtn = document.getElementById("playAudioBtn");
            if (currentWord.Audio) {
                playAudioBtn.style.display = "block";
                playAudioBtn.setAttribute("data-audio", currentWord.Audio);
            } else {
                playAudioBtn.style.display = "none";
            }
        }

        function playAudio() {
            let audioSrc = document.getElementById("playAudioBtn").getAttribute("data-audio");
            if (audioSrc) {
                let audio = new Audio(audioSrc);
                audio.play();
            }
        }

        function submitAnswer() {
            let answer = document.getElementById("answerInput").value.trim();
            if (answer.toLowerCase() === currentWord.Words.toLowerCase()) {
                document.getElementById("feedback").textContent = "✅ 正確！";
            } else {
                document.getElementById("feedback").textContent = `❌ 錯誤，正確答案是: ${currentWord.Words}`;
            }
            setTimeout(nextQuestion, 1000);
        }

        function showResults() {
            document.getElementById("quizContainer").style.display = "none";
            document.getElementById("resultContainer").style.display = "block";
        }

        function saveResults() {
            alert("測驗結果已儲存！");
        }

        function goBack() {
            window.location.href = "index.html";
        }
    </script>
</body>
</html>
