<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–®å­—æ¸¬é©—</title>
    <link rel="stylesheet" href="quiz.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Work+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js" defer></script>
    
    <script src="auth-manager.js" defer></script>
    <script src="q_sentence.js" defer></script>
    <script src="quiz.js" defer></script>
</head>
<body>
    <div id="loadingOverlay">
        <div class="spinner-container">
            <div class="spinner"></div>
            <p class="loading-text">æº–å‚™ä¸­...</p>
        </div>
    </div>

    <div id="toastNotification"></div>
    
    <!-- éºµåŒ…å±‘å°èˆª -->
    <nav id="breadcrumb-nav" class="breadcrumb-container">
        <div class="breadcrumb-content"></div>
    </nav>
    
    <header class="main-header">
        <div class="header-decoration"></div>
        <h1 class="page-title">æ¸¬é©—å€</h1>
        <div class="header-subtitle">æŒ‘æˆ°æ‚¨çš„è‹±èªèƒ½åŠ›</div>
    </header>

    <div class="quiz-type-selector">
        <button id="wordQuizBtn" class="type-card" onclick="navigateToQuizType('word')">
            <div class="card-icon">ğŸ“</div>
            <h2 class="card-title">å–®å­—æ¸¬é©—</h2>
            <p class="card-description">æ¸¬è©¦å–®å­—æ‹¼å¯«èˆ‡è¨˜æ†¶</p>
        </button>
        <button id="sentenceQuizBtn" class="type-card" onclick="navigateToQuizType('sentence')">
            <div class="card-icon">ğŸ’¬</div>
            <h2 class="card-title">å¥å­æ¸¬é©—</h2>
            <p class="card-description">ç·´ç¿’å®Œæ•´å¥å­ç†è§£</p>
        </button>
    </div>

    <div class="container">
        <!-- å–®å­—æ¸¬é©—åˆ†é¡ -->
        <div id="quizCategories" class="categories-panel">
            <div class="action-buttons">
                <button id="startFilteredQuizBtn" class="primary-button">
                    <span class="button-text">Word Quiz</span>
                </button>
                <button id="startRewordQuizBtn" class="primary-button secondary">
                    <span class="button-text">Reword Quiz</span>
                </button> 
            </div>
            
            <div class="filters-section">
                <div class="filter-group">
                    <button type="button" class="filter-header">
                        <span class="filter-title">å­—æ¯åˆ†é¡</span>
                        <span class="filter-icon">+</span>
                    </button>
                    <div class="filter-content" id="alphabetButtons"></div>
                </div>
                
                <div class="filter-group">
                    <button type="button" class="filter-header">
                        <span class="filter-title">ä¸»åˆ†é¡</span>
                        <span class="filter-icon">+</span>
                    </button>
                    <div class="filter-content" id="primaryCategoryButtons"></div>
                </div>
                
                <div class="filter-group">
                    <button type="button" class="filter-header">
                        <span class="filter-title">ç‰¹æ®Šåˆ†é¡</span>
                        <span class="filter-icon">+</span>
                    </button>
                    <div class="filter-content" id="specialCategoryButtons"></div>
                </div>
                
                <div class="filter-group">
                    <button type="button" class="filter-header">
                        <span class="filter-title">ç­‰ç´šåˆ†é¡</span>
                        <span class="filter-icon">+</span>
                    </button>
                    <div class="filter-content" id="levelButtons"></div>
                </div>
            </div>
        </div>

        <!-- å¥å­æ¸¬é©—åˆ†é¡ -->
        <div id="sentenceQuizCategories" class="categories-panel">
            <div class="action-buttons">
                <button id="startSentenceQuizBtn" class="primary-button">
                    <span class="button-text">Sentence Quiz</span>
                </button>
                <button id="startReorganizeQuizBtn" class="primary-button secondary">
                    <span class="button-text">Reorganize Quiz</span>
                </button>
            </div>
            
            <div class="filters-section">
                <div class="filter-group">
                    <button type="button" class="filter-header">
                        <span class="filter-title">å­—æ¯åˆ†é¡</span>
                        <span class="filter-icon">+</span>
                    </button>
                    <div class="filter-content" id="sentenceAlphabetButtons"></div>
                </div>
                
                <div class="filter-group">
                    <button type="button" class="filter-header">
                        <span class="filter-title">ä¸»åˆ†é¡</span>
                        <span class="filter-icon">+</span>
                    </button>
                    <div class="filter-content" id="sentencePrimaryCategoryButtons"></div>
                </div>

                <div class="filter-group">
                    <button type="button" class="filter-header">
                        <span class="filter-title">æ¬¡åˆ†é¡</span>
                        <span class="filter-icon">+</span>
                    </button>
                    <div class="filter-content" id="sentenceSecondaryCategoryButtons"></div>
                </div>
                
                <div class="filter-group">
                    <button type="button" class="filter-header">
                        <span class="filter-title">ç‰¹æ®Šåˆ†é¡</span>
                        <span class="filter-icon">+</span>
                    </button>
                    <div class="filter-content" id="sentenceSpecialCategoryButtons"></div>
                </div>
                
                <div class="filter-group">
                    <button type="button" class="filter-header">
                        <span class="filter-title">ç­‰ç´šåˆ†é¡</span>
                        <span class="filter-icon">+</span>
                    </button>
                    <div class="filter-content" id="sentenceLevelButtons"></div>
                </div>
            </div>
        </div>

        <!-- é‡çµ„æ¸¬é©—å€åŸŸ -->
        <div id="reorganizeQuizArea" class="quiz-panel">
            <button id="cancelReorganizeQuizBtn" class="back-button" onclick="returnToSentenceCategorySelection()">
                <span>â† è¿”å›</span>
            </button>
            <div id="reorganizeSentenceHint" class="quiz-hint"></div>
            <div id="sentenceConstructionArea" class="construction-zone"></div>
            <div id="wordBlocksContainer" class="blocks-pool"></div>
            <div class="quiz-controls">
                <button id="playReorganizeAudioBtn" class="control-button audio">
                    <span class="button-icon">ğŸ”Š</span>
                    <span class="button-label">æ’­æ”¾</span>
                </button>
                <button id="submitReorganizeBtn" class="control-button primary" onclick="submitReorganizeAnswer()">
                    <span class="button-label">æäº¤ç­”æ¡ˆ</span>
                </button>
                <button id="nextReorganizeBtn" class="control-button" onclick="goToNextReorganizeSentence()">
                    <span class="button-label">ä¸‹ä¸€é¡Œ</span>
                </button>
                <button class="control-button finish" onclick="finishReorganizeQuiz()">
                    <span class="button-label">å®Œæˆæ¸¬é©—</span>
                </button>
            </div>
        </div>

        <!-- Reword æ¸¬é©—å€åŸŸ -->
        <div id="rewordQuizArea" class="quiz-panel">
            <button id="cancelRewordQuizBtn" class="back-button" onclick="returnToCategorySelection()">
                <span>â† è¿”å›</span>
            </button>
            <div id="rewordHint" class="quiz-hint"></div>
            <div id="rewordConstructionArea" class="construction-zone"></div>
            <div id="rewordLetterBlocksContainer" class="blocks-pool"></div>
            <div class="quiz-controls">
                <button id="playRewordAudioBtn" class="control-button audio">
                    <span class="button-icon">ğŸ”Š</span>
                    <span class="button-label">æ’­æ”¾</span>
                </button>
                <button id="submitRewordBtn" class="control-button primary" onclick="submitRewordAnswer()">
                    <span class="button-label">æäº¤ç­”æ¡ˆ</span>
                </button>
                <button id="nextRewordBtn" class="control-button" onclick="goToNextReword()">
                    <span class="button-label">ä¸‹ä¸€é¡Œ</span>
                </button>
                <button class="control-button finish" onclick="finishRewordQuiz()">
                    <span class="button-label">å®Œæˆæ¸¬é©—</span>
                </button>
            </div>
        </div>

        <!-- å–®å­—æ¸¬é©—å€åŸŸ -->
        <div id="quizArea" class="quiz-panel">
            <button id="cancelBtn" class="back-button danger" onclick="returnToCategorySelection()">
                <span>â† å–æ¶ˆ</span>
            </button>
            <div id="wordHint" class="quiz-hint"></div>
            <div id="wordInput" class="letter-grid"></div>
            <div class="quiz-controls">
                <button id="playAudioCenterBtn" class="control-button audio">
                    <span class="button-icon">ğŸ”Š</span>
                    <span class="button-label">Voice</span>
                </button>
                <button id="submitBtn" class="control-button primary" onclick="submitAnswer()">
                    <span class="button-label">Submit</span>
                </button>
                <button id="nextBtn" class="control-button" onclick="goToNextWord()">
                    <span class="button-label">Next</span>
                </button>
                <button class="control-button finish" onclick="finishQuiz()">
                    <span class="button-label">Finish</span>
                </button>
            </div>
        </div>

        <!-- å¥å­æ¸¬é©—å€åŸŸ -->
        <div id="sentenceQuizArea" class="quiz-panel">
            <button id="cancelSentenceQuizBtn" class="back-button" onclick="returnToSentenceCategorySelection()">
                <span>â† è¿”å›</span>
            </button>
            <div id="sentenceHint" class="quiz-hint"></div>
            <div id="sentenceInput" class="sentence-input-area">
                <input type="text" id="userSentenceAnswer" class="sentence-answer-input" placeholder="è¼¸å…¥æ‚¨çš„ç­”æ¡ˆ">
            </div>
            <div class="quiz-controls">
                <button id="playSentenceAudioBtn" class="control-button audio">
                    <span class="button-icon">ğŸ”Š</span>
                    <span class="button-label">æ’­æ”¾</span>
                </button>
                <button id="submitSentenceBtn" class="control-button primary" onclick="submitSentenceAnswer()">
                    <span class="button-label">æäº¤</span>
                </button>
                <button id="nextSentenceBtn" class="control-button" onclick="goToNextSentence()">
                    <span class="button-label">ä¸‹ä¸€é¡Œ</span>
                </button>
                <button class="control-button finish" onclick="finishSentenceQuiz()">
                    <span class="button-label">å®Œæˆæ¸¬é©—</span>
                </button>
            </div>
        </div>

        <!-- æ¸¬é©—çµæœ -->
        <div id="quizResult" class="result-panel">
           <div class="result-actions">
             <button class="primary-button large" onclick="backToMenu()">
                <span class="button-text">è¿”å›é¸å–®</span>
             </button>
           </div>
        </div>
    </div>

    <script>
        // éºµåŒ…å±‘å°èˆªç³»çµ±
        window.quizEnhancements = window.quizEnhancements || {
            breadcrumbPath: [],
            currentQuizType: null
        };

        function updateBreadcrumb(path) {
            if (path) {
                window.quizEnhancements.breadcrumbPath = path;
            }
            
            const breadcrumbNav = document.getElementById('breadcrumb-nav');
            const breadcrumbContent = breadcrumbNav?.querySelector('.breadcrumb-content');
            if (!breadcrumbNav || !breadcrumbContent) return;
            
            if (!window.quizEnhancements.breadcrumbPath || window.quizEnhancements.breadcrumbPath.length === 0) {
                breadcrumbNav.classList.remove('visible');
                return;
            }
            
            breadcrumbNav.classList.add('visible');
            breadcrumbContent.innerHTML = window.quizEnhancements.breadcrumbPath.map((item, index) => {
                const isLast = index === window.quizEnhancements.breadcrumbPath.length - 1;
                let onclickAction = '';
                
                if (index === 0) {
                    onclickAction = 'backToMenu()';
                } else if (index === 1) {
                    onclickAction = 'backToQuizSelection()';
                } else {
                    onclickAction = `navigateToBreadcrumb(${index})`;
                }
                
                return `<span class="breadcrumb-item ${isLast ? 'current' : ''}" onclick="${onclickAction}">${item}</span>${!isLast ? '<span class="breadcrumb-separator">â€º</span>' : ''}`;
            }).join('');
        }

        function backToMenu() {
            window.location.href = 'index.html';
        }

        function backToQuizSelection() {
            document.getElementById('quizCategories').style.display = 'none';
            document.getElementById('sentenceQuizCategories').style.display = 'none';
            document.getElementById('quizArea').style.display = 'none';
            document.getElementById('sentenceQuizArea').style.display = 'none';
            document.getElementById('rewordQuizArea').style.display = 'none';
            document.getElementById('reorganizeQuizArea').style.display = 'none';
            document.getElementById('quizResult').style.display = 'none';
            
            // é¡¯ç¤ºæ¸¬é©—é¡å‹é¸æ“‡å€åŸŸ
            const quizTypeSelector = document.querySelector('.quiz-type-selector');
            if (quizTypeSelector) {
                quizTypeSelector.style.display = 'flex';
            }
            
            updateBreadcrumb(['é¸æ“‡åŠŸèƒ½', 'æ¸¬é©—ä¸­å¿ƒ']);
        }

        function navigateToQuizType(type) {
            window.quizEnhancements.currentQuizType = type;
            
            // éš±è—æ¸¬é©—é¡å‹é¸æ“‡å€åŸŸ
            const quizTypeSelector = document.querySelector('.quiz-type-selector');
            if (quizTypeSelector) {
                quizTypeSelector.style.display = 'none';
            }
            
            if (type === 'word') {
                document.getElementById('quizCategories').style.display = 'block';
                document.getElementById('sentenceQuizCategories').style.display = 'none';
                updateBreadcrumb(['é¸æ“‡åŠŸèƒ½', 'æ¸¬é©—ä¸­å¿ƒ', 'å–®å­—æ¸¬é©—']);
                window.location.href = 'quiz.html?show=categories';
            } else if (type === 'sentence') {
                document.getElementById('sentenceQuizCategories').style.display = 'block';
                document.getElementById('quizCategories').style.display = 'none';
                updateBreadcrumb(['é¸æ“‡åŠŸèƒ½', 'æ¸¬é©—ä¸­å¿ƒ', 'å¥å­æ¸¬é©—']);
                window.location.href = 'quiz.html?show=sentenceCategories';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const showParam = urlParams.get('show');
            const quizTypeSelector = document.querySelector('.quiz-type-selector');
            
            if (showParam === 'categories') {
                // é€²å…¥å–®å­—æ¸¬é©—åˆ†é¡ï¼Œéš±è—æ¸¬é©—é¡å‹é¸æ“‡å™¨
                if (quizTypeSelector) {
                    quizTypeSelector.style.display = 'none';
                }
                updateBreadcrumb(['é¸æ“‡åŠŸèƒ½', 'æ¸¬é©—ä¸­å¿ƒ', 'å–®å­—æ¸¬é©—']);
            } else if (showParam === 'sentenceCategories') {
                // é€²å…¥å¥å­æ¸¬é©—åˆ†é¡ï¼Œéš±è—æ¸¬é©—é¡å‹é¸æ“‡å™¨
                if (quizTypeSelector) {
                    quizTypeSelector.style.display = 'none';
                }
                updateBreadcrumb(['é¸æ“‡åŠŸèƒ½', 'æ¸¬é©—ä¸­å¿ƒ', 'å¥å­æ¸¬é©—']);
            } else {
                // æ²’æœ‰åƒæ•¸ï¼Œé¡¯ç¤ºæ¸¬é©—é¡å‹é¸æ“‡å™¨
                if (quizTypeSelector) {
                    quizTypeSelector.style.display = 'grid';
                }
                updateBreadcrumb(['é¸æ“‡åŠŸèƒ½', 'æ¸¬é©—ä¸­å¿ƒ']);
            }

            // åˆå§‹åŒ–æŠ˜ç–Šé¢æ¿åŠŸèƒ½
            const filterHeaders = document.querySelectorAll('.filter-header');
            filterHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    this.classList.toggle('active');
                    const content = this.nextElementSibling;
                    const icon = this.querySelector('.filter-icon');
                    
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                        icon.textContent = '+';
                    } else {
                        content.style.maxHeight = content.scrollHeight + 'px';
                        icon.textContent = 'âˆ’';
                    }
                });
            });
        });
    </script>
</body>
</html>
